{% extends "base.html" %}

{% block title %}Live GA4 Report - Blog{% endblock %}

{% block content %}
<article class="content-wrapper" data-aos="fade-up">
    <h1>Building a Real-Time Analytics Pipeline</h1>
    <p class="post-meta">January 28, 2026 â€¢ Data Engineering</p>

    <div class="blog-explanation">
        <p>This page demonstrates a live connection between this Flask application and the <strong>Google Analytics 4 (GA4) API</strong>.</p>
        
        <blockquote>
            <strong>The Goal:</strong> To create a transparent view of site traffic while maintaining a clean, blueprint-inspired aesthetic.
        </blockquote>
    </div>

    <div class="metrics-row">
        <div class="metric-card">
            <h4>Total Users</h4>
            <p id="totalUsers">0</p>
            <small>Last 30 Days</small>
        </div>
        <div class="metric-card">
            <h4>Daily Average</h4>
            <p id="avgUsers">0</p>
            <small>Engaged Users</small>
        </div>
    </div>

    <div class="live-report-container">
        <h3>Live Active Users (30 Day Window)</h3>
        <canvas id="activeUsersChart" height="150"></canvas>
    </div>
</article>

<style>
    /* Luna Sierra Brand Colors */
    h1 { color: #feb4b4; } /* Pink */

    .metrics-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .metric-card {
        flex: 1;
        background: #ffffff;
        border-bottom: 4px solid #fee071; /* Yellow */
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .metric-card h4 { font-size: 0.9rem; margin: 0; color: #666; }
    .metric-card p { font-size: 2rem; font-weight: bold; color: #feb4b4; margin: 5px 0; }
    .metric-card small { color: #999; }

    .live-report-container {
        background-color: #ffffff;
        border: 2px solid #fee071;
        padding: 20px;
        border-radius: 8px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const rawData = {{ report | tojson }};
    
    // 1. SORT: Oldest to Newest (Force numerical sort by date string)
    rawData.sort((a, b) => {
        return a.date.toString().localeCompare(b.date.toString());
    });

    // 2. MAP: Create Month/Day labels and grab values
    const monthNames = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
    
    const labels = rawData.map(d => {
        const dateStr = d.date.toString().replace(/[^0-9]/g, ''); // Ensure it's just numbers
        const m = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);
        return `${m}/${day}`; // Returns "01/28"
    });
    
    const values = rawData.map(d => parseInt(d.active_users) || 0);

    // 3. STATS: Update the cards at the top
    const totalActive = values.reduce((a, b) => a + b, 0);
    const averageActive = values.length > 0 ? (totalActive / values.length).toFixed(1) : 0;

    document.getElementById('totalUsers').innerText = totalActive.toLocaleString();
    document.getElementById('avgUsers').innerText = averageActive;

    // 4. RENDER: Create the chart with your brand palette
    const ctx = document.getElementById("activeUsersChart").getContext('2d');
    new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Daily Active Users",
                data: values,
                borderColor: "#feb4b4",       // Your Pink
                backgroundColor: "#fee07155", // Your Yellow (Transparent)
                fill: true,
                pointBackgroundColor: "#fee071",
                pointBorderColor: "#feb4b4",
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, grid: { color: "#f0f0f0" } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}