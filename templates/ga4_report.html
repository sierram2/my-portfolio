{% extends "base.html" %}

{% block title %}Live GA4 Report - Blog{% endblock %}

{% block content %}
<article class="content-wrapper" data-aos="fade-up">
    <h1>Building a Real-Time Analytics Pipeline</h1>
    <p class="post-meta"><i>January 28, 2026 • Google API</i></p>

    <div class="blog-explanation">
        <p><strong>Retrieving data using the Google Analytics 4 (GA4) API</strong></p>
        <p>
            Watching for traffic like a submarine sonar ping. Built using GA4’s free reporting API,
            Python on the backend, and Chart.js on the front.
        </p>
    </div>

    <div class="metrics-row">
        <div class="metric-card">
            <h4>Total Active Users</h4>
            <p id="totalUsers">0</p>
            <small>Last 30 Days</small>
        </div>
        <div class="metric-card">
            <h4>Daily Average</h4>
            <p id="avgUsers">0</p>
            <small>Active Users</small>
        </div>
    </div>

<div class="live-report-container">
    <h3>Live Active Users (30-Day Window)</h3>
    <div class="chart-wrapper">
        <canvas id="activeUsersChart"></canvas>
    </div>
</div>
</article>

<style>
    h1 { color: #feb4b4; }

    .metrics-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .metric-card {
        flex: 1;
        background: #ffffff;
        border-bottom: 4px solid #fee071;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .metric-card h4 {
        font-size: 0.9rem;
        margin: 0;
        color: #666;
    }

    .metric-card p {
        font-size: 2rem;
        font-weight: bold;
        color: #feb4b4;
        margin: 5px 0;
    }

    .metric-card small { color: #999; }

    .live-report-container {
        background: #ffffff;
        border: 2px solid #fee071;
        padding: 20px;
        border-radius: 8px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    const rawData = {{ report | tojson }};
    
    // 1. DATA MAP: Create "Month/Day" lookup
    const dataMap = {};
    rawData.forEach(d => {
        const dateObj = new Date(d.date);
        const key = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
        dataMap[key] = parseInt(d.active_users) || 0;
    });

    const finalLabels = [];
    const finalValues = [];
    
    // 2. THE SHIFT: Set the "End Date" to 48 hours ago
    const chartEnd = new Date();
    chartEnd.setDate(chartEnd.getDate() - 2);

    // 3. GENERATE 30-DAY WINDOW
    for (let i = 29; i >= 0; i--) {
        const d = new Date(chartEnd);
        d.setDate(chartEnd.getDate() - i);
        
        const m = d.getMonth() + 1;
        const day = d.getDate();
        const key = `${m}/${day}`;
        
        finalLabels.push(key);
        finalValues.push(dataMap[key] || 0);
    }

    // 4. STATS
    const total = finalValues.reduce((a, b) => a + b, 0);
    document.getElementById('totalUsers').innerText = total.toLocaleString();
    document.getElementById('avgUsers').innerText = (total / 30).toFixed(1);

    // 5. RENDER
    const ctx = document.getElementById("activeUsersChart").getContext('2d');
new Chart(ctx, {
    type: "line",
    plugins: [ChartDataLabels],
    data: {
        labels: finalLabels,
        datasets: [{
            data: finalValues,
            borderColor: "#feb4b4",
            backgroundColor: "rgba(254, 224, 113, 0.2)",
            fill: true,
            pointBackgroundColor: "#fee071",
            tension: 0.4,
            pointRadius: 4,
            datalabels: {
                align: 'top',
                offset: 5,
                color: '#feb4b4',
                font: { weight: 'bold', size: 14 },
                formatter: (value) => (value > 0 ? value : '')
            }
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
            legend: { display: false },
            datalabels: { display: true } 
        },
        layout: {
            padding: { top: 30, right: 10 } 
        },
        scales: {
            y: { 
                beginAtZero: true,
                suggestedMax: 10,
                grid: { color: "#f8f8f8" }, // Keeps it subtle
                ticks: { 
                    stepSize: 1, 
                    precision: 0,
                    color: '#666',
                    font: { size: 14, family: 'Satoshi' } // Larger Y font
                }
            },
            x: { 
                grid: { display: false },
                ticks: { 
                    color: '#666',
                    font: { size: 14, family: 'Satoshi' }, // Larger X font
                    maxRotation: 45, 
                    minRotation: 45, 
                    maxTicksLimit: 10 
                }
            }
        }
    }
});
</script>
{% endblock %}
